<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××©×—×§ ×—×©×‘×•×Ÿ ×œ×›×™×ª×” ××³ â€“ Brawl Rewards</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --ink:#ffffff; --muted:#b9c2d6;
      --accent:#2f6bff; --btn:#1a2742;
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Arial;
      background:linear-gradient(180deg,#070c16 0%, #0b1220 60%, #070c16 100%);
      color:var(--ink); min-height:100vh;
      display:flex; align-items:flex-start; justify-content:center;
      padding:14px;
      padding-bottom:120px; /* space for bottom gallery */
    }
    .wrap{width:min(920px,96vw)}
    .topbar{
      position:sticky; top:0; z-index:5;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
      backdrop-filter: blur(8px);
    }
    .pill{
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      padding:8px 10px; border-radius:999px; color:var(--muted); font-size:14px;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .card{
      background:rgba(17,27,46,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px; padding:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    h1,h2{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 280px}
    .bigQ{
      text-align:center;
      font-size: clamp(52px, 8vw, 98px);
      font-weight:900;
      letter-spacing:1px;
      padding:16px 10px;
      margin:8px 0 6px 0;
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    
      direction:ltr;
      unicode-bidi: plaintext;
    }
    .subline{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:8px;
    }
    .bar{
      height:10px; border-radius:999px; overflow:hidden;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      width:100%;
    }
    .bar > div{height:100%; width:0%;}
    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .btn{
      appearance:none; border:0; border-radius:14px; padding:12px 14px;
      background:var(--btn); color:var(--ink); font-size:22px; font-weight:800;
      cursor:pointer; width:100%;
      border:1px solid rgba(255,255,255,.10);
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0px) scale(.99)}
    .btn.primary{background:var(--accent)}
    .btn.good{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35)}
    .btn.bad{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35)}
    .tag{
      padding:4px 10px; border-radius:999px; font-size:13px; font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.15)}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      min-height:44px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .hidden{display:none !important}
    .select, .input{
      width:100%;
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 12px;
      font-size:18px;
      outline:none;
    }
    .list{margin:0; padding:0 18px 0 0; color:var(--muted)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:12px 0}
    .switchline{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px}
    .checkbox{transform:scale(1.15); accent-color: var(--accent);}

    /* Helper character */
    .helperWrap{
      display:flex; gap:12px; align-items:center; justify-content:center;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .helperCard{
      display:flex; gap:12px; align-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:10px 12px;
      max-width: 100%;
    }
    .helperImg{
      width:96px; height:96px; object-fit:contain;
      filter: drop-shadow(0 12px 20px rgba(0,0,0,.35));
      transform-origin: center;
      animation: floaty 2.2s ease-in-out infinite;
    }
    .helperImg.big{
      width:132px; height:132px;
    }
    @keyframes floaty{
      0%{transform:translateY(0px)}
      50%{transform:translateY(-4px)}
      100%{transform:translateY(0px)}
    }
    .bubble{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px 12px;
      color:var(--ink);
      font-weight:800;
      min-width: 180px;
    }
    .bubble .small{display:block; color:var(--muted); font-weight:700; margin-top:4px; font-size:13px}

    /* Bottom character gallery */
    .galleryBar{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:10;
      background:rgba(17,27,46,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:0 18px 44px rgba(0,0,0,.45);
      padding:10px 10px;
    }
    .galleryTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .galleryTitle{
      font-weight:900;
    }
    .galleryRow{
      display:flex; gap:8px;
      overflow:auto;
      padding-bottom:4px;
      scrollbar-width: thin;
    }
    .charThumbBtn{
      flex:0 0 auto;
      width:64px; height:64px;
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .charThumbBtn:hover{transform:translateY(-2px)}
    .charThumbBtn.selected{
      border-color: rgba(47,107,255,.65);
      background: rgba(47,107,255,.18);
      box-shadow: 0 10px 24px rgba(47,107,255,.18);
    }
    .charThumb{
      width:54px; height:54px; object-fit:contain;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.32));
      pointer-events:none;
    }

    /* Reward pop */
    .rewardPop{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:20;
    }
    .rewardCard{
      width:min(520px,92vw);
      background:rgba(17,27,46,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      padding:16px;
      text-align:center;
    }
    .rewardImg{
      width:220px; height:220px; object-fit:contain;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.45));
      animation: pop 650ms ease-out 1;
    }
    @keyframes pop{
      0%{transform:scale(.75); opacity:.2}
      60%{transform:scale(1.08); opacity:1}
      100%{transform:scale(1); opacity:1}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="pill">
      <span id="hello">ğŸ‘‹ ×©×œ×•×!</span>
      <span>ğŸ ×©×œ×‘: <b id="stageIdx">â€”</b>/<b id="stageTotal">10</b></span>
      <span>ğŸ§© ×©××œ×”: <b id="turnIdx">â€”</b>/<b id="turnTotal">10</b></span>
      <span>ğŸ¯ × ×™×§×•×“: <b id="score">0</b></span>
      <span>â±ï¸ ×–××Ÿ: <b id="timeLeft">â€”</b></span>
    </div>
    <div class="pill"><span class="kbd">××§×©×™×: 1â€“4 | ×¨×•×•×—=×“×™×œ×•×’</span></div>
  </div>

  <!-- LOGIN -->
  <div class="card" id="screenLogin">
    <h1>××©×—×§ ×—×©×‘×•×Ÿ ×œ×›×™×ª×” ××³</h1>
    <p class="muted">×‘×—×¨ ×©×¤×”, ×”×–×Ÿ ×©×, ×•×”×ª×—×œ ×œ×©×—×§ ğŸ®</p>

    <div class="row">
      <div class="col">
        <h2>×©×¤×”</h2>
        <select id="langSelect" class="select">
          <option value="he" selected>×¢×‘×¨×™×ª</option>
          <option value="en">English</option>
        </select>

        <div class="divider"></div>

        <h2>×©× ×©×—×§×Ÿ</h2>
        <input id="playerName" class="input" placeholder="×œ×“×•×’××”: ×“×Ÿ" maxlength="18" />

        <div class="switchline">
          <input id="musicToggle" type="checkbox" class="checkbox" checked />
          <label for="musicToggle" class="muted">××•×–×™×§×ª ×¨×§×¢</label>
        </div>

        <div class="switchline">
          <input id="sfxToggle" type="checkbox" class="checkbox" checked />
          <label for="sfxToggle" class="muted">×¦×œ×™×œ×™× ×œ×ª×©×•×‘×•×ª</label>
        </div>

        <div style="margin-top:12px">
          <button class="btn primary" id="enterBtn">×›× ×™×¡×” ×œ××©×—×§</button>
        </div>
      </div>

      <div class="col">
        <h2>××™×š ×–×” ×¢×•×‘×“?</h2>
        <ul class="list">
          <li><b>10 ×©×œ×‘×™×</b>, ×‘×›×œ ×©×œ×‘ <b>10 ×©××œ×•×ª</b>.</li>
          <li>×©×œ×‘×™× 1â€“3: <b>×—×™×‘×•×¨</b> (×¡×›×•× ×¢×“ 10).</li>
          <li>×©×œ×‘×™× 4â€“6: <b>×—×™×¡×•×¨</b> (×ª×•×¦××” ×œ× ×©×œ×™×œ×™×ª).</li>
          <li>×©×œ×‘×™× 7â€“10: <b>×—×™×‘×•×¨ + ×—×™×¡×•×¨</b> (×‘×”×ª×—×œ×” ×¢×“ 10, ××—×¨ ×›×š ×¢×“ 12).</li>
          <li>×–××Ÿ ×œ×©××œ×”: ×©×œ×‘×™× 1â€“4: 10×©×³, ×©×œ×‘×™× 5â€“7: 6×©×³, ×©×œ×‘×™× 8â€“10: 3×©×³.</li>
          <li><b>×¤×¨×¡:</b> ×× ×¢× ×™×ª × ×›×•×Ÿ ×¢×œ <b>×›×œ 10 ×”×©××œ×•×ª ×‘×©×œ×‘</b> â€“ ×ª×§×‘×œ ×“××•×ª ××§×¨××™×ª ğŸ</li>
          <li>××¤×©×¨ ×œ×‘×—×•×¨ ×“××•×ª ×××” ×©×¦×‘×¨×ª â€“ ×•×”×™× â€œ×¢×•×–×¨×ªâ€ ×œ×š ×‘×›×œ ×©××œ×”.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div class="card hidden" id="screenGame">
    <div id="stageTagLine" class="muted" style="margin-bottom:6px">â€”</div>

    <div id="questionBox" class="bigQ">â€”</div>

    <div class="helperWrap">
      <div class="helperCard">
        <img id="helperImg" class="helperImg big" alt="helper" />
        <div class="bubble">
          <span id="helperSay">×™××œ×œ×”! ×‘×•× × ×¤×ª×•×¨ ×™×—×“ ğŸ˜„</span>
          <span id="helperHint" class="small">×‘×—×¨ ×ª×©×•×‘×” ××—×ª ×-4 ×”××¤×©×¨×•×™×•×ª</span>
        </div>
      </div>
    </div>

    <div class="subline">
      <div style="flex:1 1 260px">
        <div class="bar" title="×–××Ÿ ×œ×©××œ×”"><div id="timeBar"></div></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <span class="tag" id="modeTag">â€”</span>
        <span class="tag warn" title="×›××” ×©××œ×•×ª ××—×›×•×ª ×œ×—×–×¨×”">×—×•×–×¨×•×ª: <b id="repeatCount">0</b></span>
        <span class="tag" id="speedTag">â€”</span>
      </div>
    </div>

    <div class="grid" id="answersGrid">
      <button class="btn" data-idx="0" id="ans0">â€”</button>
      <button class="btn" data-idx="1" id="ans1">â€”</button>
      <button class="btn" data-idx="2" id="ans2">â€”</button>
      <button class="btn" data-idx="3" id="ans3">â€”</button>
    </div>

    <div class="toast">
      <span id="toastText" class="muted">×‘×—×¨ ×ª×©×•×‘×”</span>
      <div style="display:flex; gap:10px; align-items:center">
        <button class="btn" style="width:auto; padding:10px 12px; font-size:16px" id="skipBtn">×“×™×œ×•×’</button>
        <button class="btn" style="width:auto; padding:10px 12px; font-size:16px" id="quitBtn">×¦×</button>
      </div>
    </div>
  </div>

  <!-- STAGE END -->
  <div class="card hidden" id="screenStageEnd">
    <h1>×¡×™×™××ª ×©×œ×‘! ğŸ¥³</h1>
    <p class="muted" id="stageSummary">â€”</p>

    <div class="row">
      <div class="col"><button class="btn primary" id="nextStageBtn">×œ×©×œ×‘ ×”×‘×</button></div>
      <div class="col"><button class="btn" id="backLoginBtn">×—×–×¨×” ×œ××¡×š ×›× ×™×¡×”</button></div>
    </div>
  </div>

  <!-- GAME END -->
  <div class="card hidden" id="screenGameEnd">
    <h1>×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”×©×œ×‘×™×! ğŸ†</h1>
    <p class="muted" id="gameSummary">â€”</p>
    <div class="row">
      <div class="col"><button class="btn primary" id="playAgainBtn">×©×—×§ ×©×•×‘ ××”×”×ª×—×œ×”</button></div>
      <div class="col"><button class="btn" id="backLoginBtn2">×—×–×¨×” ×œ××¡×š ×›× ×™×¡×”</button></div>
    </div>
  </div>

</div>


<!-- Audio unlock banner (helps on mobile) -->
<div class="card hidden" id="audioBanner" style="position:fixed; left:12px; right:12px; top:74px; z-index:30; padding:10px 12px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <div style="font-weight:900">ğŸ”Š ×›×“×™ ×œ×©××•×¢ ×¦×œ×™×œ×™× â€“ ×œ×—×¥ ×›××Ÿ ×¤×¢× ××—×ª</div>
    <button class="btn primary" id="enableAudioBtn" style="width:auto; padding:10px 14px; font-size:16px">×”×¤×¢×œ ×©××¢</button>
  </div>
</div>

<!-- Bottom gallery -->
<div class="galleryBar hidden" id="galleryBar">
  <div class="galleryTop">
    <div class="galleryTitle">ğŸ§© ×”×“××•×™×•×ª ×©×¦×‘×¨×ª</div>
    <div class="muted" style="font-weight:800">×œ×—×¥ ×¢×œ ×“××•×ª ×›×“×™ ×œ×‘×—×•×¨ â€œ×¢×•×–×¨â€</div>
  </div>
  <div class="galleryRow" id="galleryRow"></div>
</div>

<!-- Reward pop -->
<div class="rewardPop hidden" id="rewardPop" role="dialog" aria-modal="true">
  <div class="rewardCard">
    <h2 style="margin:0 0 10px 0">ğŸ ×–×›×™×ª ×‘×“××•×ª ×—×“×©×”!</h2>
    <img id="rewardImg" class="rewardImg" alt="reward" />
    <p class="muted" style="margin:10px 0 12px 0">×”×“××•×ª × ×•×¡×¤×” ×œ××•×¡×£ ×©×œ×š. ××¤×©×¨ ×œ×‘×—×•×¨ ××•×ª×” ×œ××˜×”.</p>
    <button class="btn primary" id="rewardOkBtn" style="max-width:320px; margin:0 auto">×™××œ×œ×” ×××©×™×›×™×!</button>
  </div>
</div>

<script src="characters.js"></script>
<script>
(() => {
  // ---------------- Helpers ----------------
  const el = (id) => document.getElementById(id);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const randInt = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
  const shuffle = (arr) => {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };
  function showScreen(which){
    ['screenLogin','screenGame','screenStageEnd','screenGameEnd'].forEach(id=>el(id).classList.add('hidden'));
    el(which).classList.remove('hidden');
  }

  // ---------------- Audio ----------------
  let audioCtx = null;
  let musicTimer = null;
  let musicOn = true;
  let sfxOn = true;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function unlockAudio(){
    try{
      // Create AudioContext only upon user gesture (mobile/Safari)
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(audioCtx.state === 'suspended'){
        audioCtx.resume();
      }
      // Prime: play a near-silent buffer once (helps some iOS/Safari cases)
      const buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      const g = audioCtx.createGain();
      g.gain.value = 0.00001;
      src.connect(g); g.connect(audioCtx.destination);
      src.start(0);
      src.stop(0.01);
    }catch(e){}
  }
  // Try unlock on first user gesture (mobile/Safari)
  window.addEventListener('pointerdown', () => unlockAudio(), { passive:true });
  window.addEventListener('touchstart', () => unlockAudio(), { passive:true });
  window.addEventListener('keydown', () => unlockAudio(), { passive:true });

  function unlockAudio(){
    try{
      ensureAudio();
      if(audioCtx && audioCtx.state === 'suspended'){
        audioCtx.resume();
      }
    }catch(e){}
  }
  // Unlock audio on first user interaction (mobile/Safari)
  window.addEventListener('pointerdown', () => unlockAudio(), { once:true });
  window.addEventListener('keydown', () => unlockAudio(), { once:true });

  function stopMusic(){
    if(musicTimer){
      try{ clearInterval(musicTimer); }catch(e){}
      try{ clearTimeout(musicTimer); }catch(e){}
      musicTimer = null;
    }
  }
  function startMusic(){
    if(!musicOn) return;
    ensureAudio();
    stopMusic();

    // Epic-ish loop: bass + lead + light drums + subtle delay
    const bpm = 118;
    const stepSec = (60 / bpm) / 4; // 16th notes
    const root = 196; // G3-ish
    const chord = [0, 7, 12]; // power chord (root + fifth + octave)
    const melody = [0, 7, 12, 14, 12, 7, 5, 7]; // heroic-ish

    // master chain
    const master = audioCtx.createGain();
    master.gain.value = 0.35;

    const comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -22;
    comp.knee.value = 24;
    comp.ratio.value = 6;
    comp.attack.value = 0.004;
    comp.release.value = 0.12;

    // simple delay for space
    const delay = audioCtx.createDelay(0.35);
    delay.delayTime.value = 0.18;
    const fb = audioCtx.createGain();
    fb.gain.value = 0.22;
    delay.connect(fb);
    fb.connect(delay);

    master.connect(comp);
    comp.connect(audioCtx.destination);
    comp.connect(delay);
    delay.connect(comp);

    function playTone(freq, dur, type, gain, when){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, when);
      g.gain.setValueAtTime(0.0001, when);
      g.gain.exponentialRampToValueAtTime(gain, when + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, when + dur);
      o.connect(g);
      g.connect(master);
      o.start(when);
      o.stop(when + dur + 0.02);
    }

    function kick(when){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(120, when);
      o.frequency.exponentialRampToValueAtTime(50, when + 0.10);
      g.gain.setValueAtTime(0.0001, when);
      g.gain.exponentialRampToValueAtTime(0.22, when + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, when + 0.14);
      o.connect(g); g.connect(master);
      o.start(when); o.stop(when + 0.16);
    }

    function snare(when){
      const dur = 0.09;
      const n = Math.floor(audioCtx.sampleRate * dur);
      const buf = audioCtx.createBuffer(1, n, audioCtx.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<n;i++){
        d[i] = (Math.random()*2-1) * Math.exp(-i/(n/6));
      }
      const src = audioCtx.createBufferSource();
      src.buffer = buf;

      const hp = audioCtx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.value = 1600;

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, when);
      g.gain.exponentialRampToValueAtTime(0.16, when + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, when + dur);

      src.connect(hp); hp.connect(g); g.connect(master);
      src.start(when); src.stop(when + dur);
    }

    let step = 0;
    let nextTime = audioCtx.currentTime + 0.05;

    function schedule(){
      const now = audioCtx.currentTime;
      while(nextTime < now + 0.20){
        const s = step % 16;

        // Drums: kick on 1 and 9, snare on 5 and 13
        if(s === 0 || s === 8) kick(nextTime);
        if(s === 4 || s === 12) snare(nextTime);

        // Bass on quarters
        if(s % 4 === 0){
          playTone(root, 0.18, "sine", 0.09, nextTime);
        }

        // Chord stabs on 1 and 9
        if(s === 0 || s === 8){
          chord.forEach(semi => playTone(root * Math.pow(2, semi/12), 0.22, "triangle", 0.035, nextTime));
        }

        // Lead melody on every 2 steps
        if(s % 2 === 0){
          const m = melody[(step/2) % melody.length];
          const f = (root*2) * Math.pow(2, m/12);
          playTone(f, 0.12, "sawtooth", 0.03, nextTime);
        }

        step++;
        nextTime += stepSec;
      }
      musicTimer = setTimeout(schedule, 80);
    }

    schedule();
  }, stepMs);
  }
  function sfxCorrect(){
    if(!sfxOn) return;
    ensureAudio();
    const now = audioCtx.currentTime;

    // clap-like noise burst
    const bufferSize = Math.floor(audioCtx.sampleRate * 0.12);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++){
      data[i] = (Math.random()*2-1) * Math.exp(-i/(bufferSize/6));
    }
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;

    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.value = 1600;
    bp.Q.value = 1.2;

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.001, now);
    g.gain.exponentialRampToValueAtTime(0.10, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
    noise.connect(bp); bp.connect(g); g.connect(audioCtx.destination);
    noise.start(now); noise.stop(now + 0.13);

    // little "ding"
    const o = audioCtx.createOscillator();
    const g2 = audioCtx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(880, now);
    o.frequency.exponentialRampToValueAtTime(1320, now + 0.08);
    g2.gain.setValueAtTime(0.001, now);
    g2.gain.exponentialRampToValueAtTime(0.06, now + 0.01);
    g2.gain.exponentialRampToValueAtTime(0.001, now + 0.10);
    o.connect(g2); g2.connect(audioCtx.destination);
    o.start(now); o.stop(now + 0.11);
  }
  function sfxWrong(){
    if(!sfxOn) return;
    ensureAudio();
    const now = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sawtooth";
    o.frequency.setValueAtTime(220, now);
    o.frequency.exponentialRampToValueAtTime(120, now + 0.14);
    g.gain.setValueAtTime(0.001, now);
    g.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now + 0.16);
    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 900;
    o.connect(lp); lp.connect(g); g.connect(audioCtx.destination);
    o.start(now); o.stop(now + 0.18);
  }

  // ---------------- Characters ----------------
  const ALL = (window.BRAWL_CHARACTERS || []).slice();
  function charSrc(name){ return `characters/${name}`; }

  const STORAGE_KEY = "brawl_math_rewards_v1";

  function loadProgress(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function saveProgress(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        player: state.player,
        collected: state.collected,
        selected: state.selectedChar,
      }));
    }catch(e){}
  }

  function initCharactersIfNeeded(){
    // Give a starter helper so the gallery isn't empty:
    if(state.collected.length === 0 && ALL.length){
      const starter = ALL[randInt(0, ALL.length-1)];
      state.collected.push(starter);
      state.selectedChar = starter;
    }
    renderGallery();
    applySelectedHelper();
    saveProgress();
  }

  function renderGallery(){
    const bar = el('galleryBar');
    const row = el('galleryRow');
    row.innerHTML = "";

    if(state.collected.length === 0){
      bar.classList.add('hidden');
      return;
    }
    bar.classList.remove('hidden');

    state.collected.forEach((name) => {
      const btn = document.createElement('button');
      btn.className = "charThumbBtn" + (name === state.selectedChar ? " selected" : "");
      btn.title = "×‘×—×¨ ×“××•×ª";
      const img = document.createElement('img');
      img.className = "charThumb";
      img.alt = "brawler";
      img.src = charSrc(name);
      btn.appendChild(img);

      btn.addEventListener('click', () => {
        state.selectedChar = name;
        renderGallery();
        applySelectedHelper(true);
        saveProgress();
      });

      row.appendChild(btn);
    });
  }

  function helperSaysForStage(){
    const pool = [
      "×™××œ×œ×”! ××ª×” ×™×›×•×œ ğŸ˜„",
      "× ×‘×“×•×§ ×™×—×“ â€” ×ª×ª×¨×›×–!",
      "×ª×©×•×‘×” × ×›×•× ×” = × ×§×•×“×”!",
      "×§×•×“× ××—×©×‘×™×, ×•××– ×‘×•×—×¨×™×.",
      "××ª×” ××œ×•×£/××œ×•×¤×” ğŸ’ª",
      "× ×©××¨ ×§×¦×ª ×–××Ÿ â€” ××”×¨!",
      "×‘×•× × ×©××•×¨ ×¢×œ ×“×™×•×§ ğŸ¯",
      "×× ×™ ××™×ª×š!"
    ];
    return pool[randInt(0, pool.length-1)];
  }

  function applySelectedHelper(animate=false){
    const img = el('helperImg');
    const say = el('helperSay');
    const hint = el('helperHint');

    if(state.selectedChar){
      img.src = charSrc(state.selectedChar);
      img.style.opacity = "1";
    } else {
      img.removeAttribute('src');
      img.style.opacity = "0.5";
    }
    say.textContent = helperSaysForStage();
    hint.textContent = "×‘×—×¨ ×ª×©×•×‘×” ××—×ª ×-4 ×”××¤×©×¨×•×™×•×ª";

    if(animate){
      img.style.transition = "transform 140ms ease";
      img.style.transform = "scale(1.08)";
      setTimeout(()=>{ img.style.transform = "scale(1)"; }, 180);
    }
  }

  function awardRandomCharacter(){
    if(ALL.length === 0) return null;

    // choose from not-yet-collected if possible
    const remaining = ALL.filter(x => !state.collected.includes(x));
    const pickFrom = remaining.length ? remaining : ALL;
    const chosen = pickFrom[randInt(0, pickFrom.length-1)];

    if(!state.collected.includes(chosen)){
      state.collected.push(chosen);
    }
    state.selectedChar = chosen;
    saveProgress();
    renderGallery();
    applySelectedHelper(true);
    return chosen;
  }

  function showRewardPop(charName){
    if(!charName) return;
    el('rewardImg').src = charSrc(charName);
    el('rewardPop').classList.remove('hidden');
  }
  function hideRewardPop(){
    el('rewardPop').classList.add('hidden');
  }

  // ---------------- Game Config ----------------
  const TOTAL_STAGES = 10;
  const TURNS_PER_STAGE = 10;

  function stageMode(stage){
    if(stage <= 3) return 'add';
    if(stage <= 6) return 'sub';
    return 'mix';
  }
  function stageSeconds(stage){
    if(stage <= 4) return 10;
    if(stage <= 7) return 6;
    return 3;
  }
  function stageAddMaxSum(stage){
    // ×¡×›×•× ×—×™×‘×•×¨ ×œ×¤×™ ×§×•×©×™:
    // ×©×œ×‘×™× ×§×œ×™× (1â€“3 ×—×™×‘×•×¨) ×•×¢×“ ×©×œ×‘ 7 (×ª×—×™×œ×ª ×—×™×‘×•×¨+×—×™×¡×•×¨): ×¢×“ 10
    // ×©×œ×‘×™× ××ª×§×“××™× (8â€“10): ×¢×“ 12
    if(stage <= 3) return 10;
    if(stage === 7) return 10;
    return 12;
  }
  function modeLabel(mode){
    if(mode === 'add') return '×—×™×‘×•×¨';
    if(mode === 'sub') return '×—×™×¡×•×¨';
    return '×—×™×‘×•×¨+×—×™×¡×•×¨';
  }

  // ---------------- State ----------------
  let state = {
    player: '×©×—×§×Ÿ',
    stage: 1,
    turn: 1,
    scoreStage: 0,
    scoreTotal: 0,
    wrongThisStage: 0,
    timer: null,
    timeLeftMs: 0,
    allowInput: true,
    current: null,
    baseQueue: [],
    mistakesPool: [],
    seenKeys: new Set(),

    // characters progress
    collected: [],
    selectedChar: null,
  };

  // ---------------- Questions ----------------
  function makeQuestionForStage(stage){
    const mode = stageMode(stage);
    let a=0,b=0,op='+',answer=0;
    const maxSum = stageAddMaxSum(stage);

    if(mode === 'add'){
      op = '+';
      a = randInt(0,9);
      b = randInt(0,9);
      let tries=0;
      while(a+b > maxSum && tries < 60){
        a = randInt(0,9); b = randInt(0,9); tries++;
      }
      if(a+b > maxSum) b = clamp(maxSum - a, 0, 9);
      answer = a + b;
    } else if(mode === 'sub'){
      op = 'âˆ’';
      a = randInt(0,9);
      b = randInt(0,9);
      if(b > a) [a,b] = [b,a];
      answer = a - b;
    } else {
      const pickAdd = Math.random() < 0.5;
      if(pickAdd){
        op = '+';
        a = randInt(0,9);
        b = randInt(0,9);
        let tries=0;
        while(a+b > maxSum && tries < 60){
          a = randInt(0,9); b = randInt(0,9); tries++;
        }
        if(a+b > maxSum) b = clamp(maxSum - a, 0, 9);
        answer = a + b;
      } else {
        op = 'âˆ’';
        a = randInt(0,9);
        b = randInt(0,9);
        if(b > a) [a,b] = [b,a];
        answer = a - b;
      }
    }
    return { a,b,op,answer, text:`${a} ${op} ${b} =`, key:`${a}${op}${b}`, options:[], attempts:0 };
  }

  function makeOptions(correct){
    const set = new Set([correct]);
    const opts = [correct];
    const deltas = shuffle([-3,-2,-1,1,2,3,4,-4,5,-5]);
    for(const d of deltas){
      if(opts.length >= 4) break;
      const cand = correct + d;
      if(cand < 0 || cand > 12) continue;
      if(!set.has(cand)){ set.add(cand); opts.push(cand); }
    }
    while(opts.length < 4){
      const cand = randInt(0, 12);
      if(!set.has(cand)){ set.add(cand); opts.push(cand); }
    }
    return shuffle(opts);
  }

  function buildStageQueues(){
    state.baseQueue = [];
    state.mistakesPool = [];
    state.seenKeys = new Set();

    let guard=0;
    while(state.baseQueue.length < TURNS_PER_STAGE && guard < 600){
      const q = makeQuestionForStage(state.stage);
      if(!state.seenKeys.has(q.key)){
        state.seenKeys.add(q.key);
        state.baseQueue.push(q);
      }
      guard++;
    }
    while(state.baseQueue.length < TURNS_PER_STAGE){
      state.baseQueue.push(makeQuestionForStage(state.stage));
    }
  }

  // ---------------- UI ----------------
  function paintTimeBar(ratio){
    const pct = clamp(ratio, 0, 1) * 100;
    el('timeBar').style.width = pct.toFixed(1) + '%';
    if(pct > 50) el('timeBar').style.background = 'rgba(255,255,255,.28)';
    else if(pct > 20) el('timeBar').style.background = 'rgba(255,255,255,.20)';
    else el('timeBar').style.background = 'rgba(255,255,255,.14)';
  }

  function updateTop(){
    el('hello').textContent = `ğŸ‘‹ ×©×œ×•×, ${state.player}!`;
    el('stageIdx').textContent = String(state.stage);
    el('stageTotal').textContent = String(TOTAL_STAGES);
    el('turnIdx').textContent = String(state.turn);
    el('turnTotal').textContent = String(TURNS_PER_STAGE);
    el('score').textContent = String(state.scoreTotal);
    el('repeatCount').textContent = String(state.mistakesPool.length);
    el('timeLeft').textContent = (state.timeLeftMs>0) ? String(Math.ceil(state.timeLeftMs/1000)) : 'â€”';

    const mode = stageMode(state.stage);
    el('modeTag').textContent = modeLabel(mode);
    el('speedTag').textContent = `â±ï¸ ${stageSeconds(state.stage)}×©×³`;
    el('stageTagLine').textContent = `×©×œ×‘ ${state.stage} â€¢ ××¦×‘: ${modeLabel(mode)}`;
  }

  function toast(msg){ el('toastText').textContent = msg; }

  function setAnswers(options){
    for(let i=0;i<4;i++){
      const b = el('ans'+i);
      b.textContent = String(options[i]);
      b.classList.remove('good','bad');
      b.disabled = false;
    }
  }
  function lockInput(lock){
    state.allowInput = !lock;
    for(let i=0;i<4;i++) el('ans'+i).disabled = lock;
    el('skipBtn').disabled = lock;
  }

  // ---------------- Timer ----------------
  function stopTimer(){
    if(state.timer){ clearInterval(state.timer); state.timer = null; }
  }
  function startTimer(seconds){
    stopTimer();
    const totalMs = seconds * 1000;
    state.timeLeftMs = totalMs;
    paintTimeBar(1);
    updateTop();
    state.timer = setInterval(() => {
      state.timeLeftMs -= 100;
      const left = Math.max(0, state.timeLeftMs);
      paintTimeBar(left/totalMs);
      el('timeLeft').textContent = String(Math.ceil(left/1000));
      if(left <= 0){
        stopTimer();
        onTimeout();
      }
    }, 100);
  }

  // ---------------- Turn Flow ----------------
  function pickNextQuestion(){
    if(state.mistakesPool.length > 0 && Math.random() < 0.55){
      return state.mistakesPool.shift();
    }
    return state.baseQueue[state.turn - 1];
  }

  function renderTurn(){
    const q = pickNextQuestion();
    state.current = q;

    el('questionBox').textContent = q.text;
    q.options = makeOptions(q.answer);
    setAnswers(q.options);

    applySelectedHelper(); // refresh helper text occasionally
    toast('×‘×—×¨ ×ª×©×•×‘×”');
    lockInput(false);
    startTimer(stageSeconds(state.stage));
    updateTop();
  }

  function markButtons(correctValue, chosenValue){
    for(let i=0;i<4;i++){
      const b = el('ans'+i);
      const val = Number(b.textContent);
      if(val === correctValue) b.classList.add('good');
      if(val === chosenValue && chosenValue !== correctValue) b.classList.add('bad');
    }
  }

  function addMistake(q){
    if((q.attempts || 0) >= 5) return;
    state.mistakesPool.push({ ...q, options: [], attempts: q.attempts || 0 });
  }

  function onAnswer(idx){
    if(!state.allowInput) return;
    const q = state.current;
    const chosen = q.options[idx];

    stopTimer();
    lockInput(true);

    const ok = chosen === q.answer;
    q.attempts++;

    markButtons(q.answer, chosen);

    if(ok){
      state.scoreStage += 1;
      state.scoreTotal += 1;
      sfxCorrect();
      toast('âœ… × ×›×•×Ÿ! × ×§×•×“×” +1');
      setTimeout(() => nextAfterAnswer(), 600);
    } else {
      state.wrongThisStage += 1;
      sfxWrong();
      toast('âŒ ×œ× × ×›×•×Ÿ. × × ×¡×” ×©×•×‘ ×‘×”××©×š ×”×©×œ×‘');
      addMistake(q);
      setTimeout(() => nextAfterAnswer(), 850);
    }
    updateTop();
  }

  function onTimeout(){
    if(!state.allowInput) return;
    const q = state.current;
    lockInput(true);
    state.wrongThisStage += 1;
    sfxWrong();
    toast('â±ï¸ × ×’××¨ ×”×–××Ÿ! × × ×¡×” ×©×•×‘ ×‘×”××©×š ×”×©×œ×‘');
    q.attempts = (q.attempts || 0) + 1;
    addMistake(q);
    setTimeout(() => nextAfterAnswer(), 850);
    updateTop();
  }

  function onSkip(){
    if(!state.allowInput) return;
    stopTimer();
    lockInput(true);
    state.wrongThisStage += 1;
    sfxWrong();
    toast('â­ï¸ ×“×™×œ×•×’. × × ×¡×” ×©×•×‘ ×‘×”××©×š ×”×©×œ×‘');
    const q = state.current;
    q.attempts = (q.attempts || 0) + 1;
    addMistake(q);
    setTimeout(() => nextAfterAnswer(), 750);
    updateTop();
  }

  function nextAfterAnswer(){
    lockInput(false);

    if(state.turn >= TURNS_PER_STAGE){
      return showStageEnd();
    }
    state.turn += 1;
    renderTurn();
  }

  function showStageEnd(){
    stopTimer();
    showScreen('screenStageEnd');

    const perfect = (state.scoreStage === TURNS_PER_STAGE); // 10 successful questions
    const summary = `×©×œ×‘ ${state.stage}: × ×™×§×•×“ ${state.scoreStage}/${TURNS_PER_STAGE}. ×˜×¢×•×™×•×ª/×–××Ÿ: ${state.wrongThisStage}.`;
    el('stageSummary').textContent = summary + (perfect ? " ğŸ‰ ××•×©×œ×! ×§×™×‘×œ×ª ×“××•×ª ×—×“×©×”!" : "");

    // Award on perfect stage
    if(perfect){
      const won = awardRandomCharacter();
      showRewardPop(won);
    }

    // Next stage button availability
    if(state.stage >= TOTAL_STAGES){
      el('nextStageBtn').textContent = "×¡×™×•× ××©×—×§";
    } else {
      el('nextStageBtn').textContent = "×œ×©×œ×‘ ×”×‘×";
    }
  }

  function startStage(stageNumber){
    state.stage = stageNumber;
    state.turn = 1;
    state.scoreStage = 0;
    state.wrongThisStage = 0;

    buildStageQueues();

    showScreen('screenGame');
    updateTop();
    renderTurn();
  }

  function finishGame(){
    stopTimer();
    showScreen('screenGameEnd');
    el('gameSummary').textContent = `× ×™×§×•×“ ×›×•×œ×œ: ${state.scoreTotal}/${TOTAL_STAGES*TURNS_PER_STAGE}. ×”×“××•×™×•×ª ×©×¦×‘×¨×ª: ${state.collected.length}.`;
  }

  // ---------------- Wiring ----------------
  if(el('enableAudioBtn')){
    el('enableAudioBtn').addEventListener('click', async () => {
      unlockAudio();
      
    // If mobile still blocks audio, show the banner button
    try{
      if(audioCtx && audioCtx.state === 'suspended') el('audioBanner').classList.remove('hidden');
      else el('audioBanner').classList.add('hidden');
    }catch(e){}
try{ if(audioCtx) await audioCtx.resume(); }catch(e){}
      el('audioBanner').classList.add('hidden');
      if(musicOn) startMusic();
    });
  }

  el('enterBtn').addEventListener('click', async () => {
    
    
    unlockAudio();
unlockAudio();
const name = (el('playerName').value || '').trim();
    state.player = name || "×©×—×§×Ÿ";

    musicOn = el('musicToggle').checked;
    sfxOn = el('sfxToggle').checked;

    if(musicOn){
      unlockAudio();
      ensureAudio();
      try{ await audioCtx.resume(); }catch(e){}
      startMusic();
    }

    // load saved characters (per device)
    const saved = loadProgress();
    if(saved && Array.isArray(saved.collected)){
      state.collected = saved.collected.filter(x => ALL.includes(x));
      state.selectedChar = (saved.selected && ALL.includes(saved.selected)) ? saved.selected : (state.collected[0] || null);
    } else {
      state.collected = [];
      state.selectedChar = null;
    }

    initCharactersIfNeeded();

    // reset scores
    state.scoreTotal = 0;

    showScreen('screenGame');
    startStage(1);
  });

  el('quitBtn').addEventListener('click', () => {
    stopTimer(); stopMusic();
    showScreen('screenLogin');
  });
  el('skipBtn').addEventListener('click', onSkip);
  for(let i=0;i<4;i++){
    el('ans'+i).addEventListener('click', () => onAnswer(i));
  }
  window.addEventListener('keydown', (e) => {
    if(el('screenGame').classList.contains('hidden')) return;
    if(e.key === '1') onAnswer(0);
    if(e.key === '2') onAnswer(1);
    if(e.key === '3') onAnswer(2);
    if(e.key === '4') onAnswer(3);
    if(e.key === ' '){ e.preventDefault(); onSkip(); }
  });

  el('nextStageBtn').addEventListener('click', () => {
    if(state.stage >= TOTAL_STAGES){
      finishGame();
      return;
    }
    startStage(state.stage + 1);
  });

  function backToLogin(){
    stopTimer(); stopMusic();
    showScreen('screenLogin');
  }
  el('backLoginBtn').addEventListener('click', backToLogin);
  el('backLoginBtn2').addEventListener('click', backToLogin);

  el('playAgainBtn').addEventListener('click', async () => {
    musicOn = el('musicToggle').checked;
    sfxOn = el('sfxToggle').checked;
    if(musicOn){
      unlockAudio();
      ensureAudio();
      try{ await audioCtx.resume(); }catch(e){}
      startMusic();
    }
    state.scoreTotal = 0;
    startStage(1);
  });

  el('rewardOkBtn').addEventListener('click', () => {
    hideRewardPop();
  });

  // Init
  showScreen('screenLogin');
})();
</script>
</body>
</html>
